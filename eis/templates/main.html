<html>
    <head>
        <meta name="keywords" content="员工信息管理系统" />
        <meta name="description" content="员工信息管理系统" />
        <link href="/static/resources/css/ext-all-neptune.css" rel="stylesheet" type="text/css"/>
        <script src="/static/js/ext-all.js" type="text/javascript"></script>
        <script src="/static/js/locale/ext-lang-zh_CN.js" type="text/javascript"></script>
        <script>
                Ext.Ajax.on('beforerequest', function(conn, options) {
                if (!(/^http:.*/.test(options.url) || /^https:.*/.test(options.url))) {

                    if(Ext.util.Cookies.get('csrftoken')==null){
                        Ext.util.Cookies.set('csrftoken','csrftoken')
                    }
                    if (typeof(options.headers) == "undefined") {
                        options.headers = {'X-CSRFToken': Ext.util.Cookies.get('csrftoken')};
                        } else {

                        options.headers['X-CSRFToken']=Ext.util.Cookies.get('csrftoken');
                    }
                }
            }, this);

            Ext.onReady(function()
            {
                Ext.tip.QuickTipManager.init();

                var sexdata=[{'name':1,'value':'男'},{'name':2,'value':'女'}];
                var sexstore=Ext.create('Ext.data.Store',{
                    data:sexdata,
                    fields:['name','value'],
                });
                console.log(sexstore)
                var north = new Ext.panel.Panel({
                    region: 'north',
                    title: '员工信息管理系统',
                    height:30,
                    html:'<font siez="6"><b>员工信息管理系统 </b></font>' 
                });
                var storeStaff = Ext.create('Ext.data.Store',{
                    id:'storeStaff',
                    pageSize:25,
                    idProperty:'pk',
                    fields:[{name: 'id', mapping: 'pk'},
                    {name: 'name', mapping: 'fields.name'}, 
                    {name: 'age', mapping: 'fields.age'}, 
                    {name: 'sex', mapping: 'fields.sex'}, 
                    {name: 'workage', mapping: 'fields.workage'}, 
                    {name: 'edu', mapping: 'fields.edu'},
                    {name: 'salary', mapping: 'fields.salary'},
                    {name: 'address', mapping: 'fields.address'}],
                    proxy:{
                        type:'jsonp',
                        url:'/ajax_staff_list/',
                        reader:{
                            successProperty: 'success',
                            root: 'records',
                        },
                        simpleSortMode: true,
                        listeners: {
                            exception: function(proxy, request, operation, options) {
                                Ext.Msg.alert("错误", proxy.getReader().rawData['msg']);
                            }
                        }
                    },
                    listeners:{
                        beforeload: function(store,options){
                            Ext.apply(store.proxy.extraParams,{
                                name: Ext.getCmp("name").getValue(),
                            });
                        }
                    }
                });

                var win = Ext.create('widget.window', {
                title: '添加员工信息',
                width: 350,
                layout: 'fit',
                closable: true,
                closeAction: 'hide',
                modal: true,
                resizable: false,
                items: [Ext.create('Ext.form.Panel', {
                id: 'frmStaff',
                bodyStyle:'padding:20px 0 0 20px',
                border: false,
                autoScroll: false,
                url:'/ajax_staff_add/',
                fieldDefaults: {
                labelAlign: 'left',
                labelWidth: 70, 
                msgTarget: 'side'
                },
                items: [{
                xtype:'textfield',
                id: 'staff.name',
                name: 'name',
                fieldLabel: '姓名',
                allowBlank: false,
                maxLength:30,
                },{
                xtype:'numberfield',
                id: 'age',
                name: 'age',
                fieldLabel: '年龄',
                allowBlank: false,
                maxLength:3,
                },{
                xtype:'combo',
                id: 'sex', 
                name: 'sex',
                fieldLabel: '性别',
                store:sexstore,
                valueField:'name',
                displayField:'value',
                editable:false,
                allowBlank: false,
                },{
                xtype:'textfield',
                id:'edu',
                name:'edu',
                fieldLabel:'毕业学校',
                allowBlank: false,
                maxLength:100,
                },{
                xtype:'numberfield',
                id:'workage',
                name:'workage',
                fieldLabel:'工龄',
                allowBlank: false,
                maxLength:2,
                },{
                xtype:'numberfield',
                id:'salary',
                name:'salary',
                fieldLabel:'薪水',
                allowBlank: false,
                maxLength:10,
                },{
                xtype:'textfield',
                id:'address',
                name:'address',
                fieldLabel:'居住地址',
                allowBlank: false,
                maxLength:200,
                }]
                })],
                buttons: [{
                id: "btnOK",
                text:'确定',    
                handler: function(){
                Ext.getCmp('frmStaff').form.submit(
                {
                success: function(form, action){
                var json = Ext.JSON.decode(action.response.responseText);
                if (json.success=='true') {
                storeStaff.load();      
                }else{
                Ext.Msg.alert('错误信息',json.msg);
                }
                win.hide();
                },
                failure: function(form, action){
                Ext.Msg.alert('系统异常',action.response.responseText.msg);
                }, 
                }
                );
                }
                },{
                id: "btnCancel",
                text:'取消',
                handler: function(){
                win.hide();
                }
                }]
                });

                var btnBar =  Ext.create('Ext.Toolbar', {
                items: [{
                id:'btnAdd',
                text:'增加',
                iconCls:'icon-add',
                handler: function(btn,event){
                    win.show(this,function(){
                        Ext.getCmp('frmStaff').getForm().reset();
                    })
                }
                },{
                id:'btnDel',
                text:'删除',
                disabled:true,
                iconCls:'icon-del',
                handler:function(btn,event){
                var rows = gridPanel.selModel.getSelection();
                Ext.Msg.show({
                title : '提示',
                msg : '确定要删除吗？',
                buttons : Ext.Msg.OKCANCEL,
                icon : Ext.MessageBox.QUESTION,
                fn : function(btn, text) {
                if (btn == 'ok') {
                // 构建Ajax参数
                var ajaxparams = "ids=";
                for ( var i = 0; i < rows.length; i++) {
                ajaxparams += rows[i].get('id');
                if (i < rows.length - 1) 
                ajaxparams += ",";
                }
                // 发送请求
                Ext.Ajax.request({
                url: '/ajax_staff_del/',
                params: ajaxparams,
                method: "GET",
                waitMsg : "正在删除...",
                success : function(response, options) {
                var json = Ext.JSON.decode(response.responseText);
                if (json.success=='true') {
                storeStaff.load();
                }else{
                Ext.Msg.alert("提示", json.msg);
                }
                },
                failure : function(response, options) {
                Ext.ajaxFailure(response, options);
                }
                });
                }
                }
                });
                }
                }],
                });

                var filterBar= Ext.create('Ext.Toolbar', {
                defaults: { 
                listeners: {
                specialkey: function(obj,e){
                if(e.getCharCode()==e.ENTER){
                Ext.getCmp("btnSearch").handler();
                }
                }
                }
                },
                items: [{
                id: 'name',
                name: 'name',
                xtype: 'textfield',
                fieldLabel: '姓名',
                width:150,
                labelWidth: 40
                },{
                id:'btnSearch',
                xtype: 'button',
                text: '查询',
                iconCls: 'icon-search',
                handler: function(btn, event) {
                storeStaff.loadPage(1);
                }
                }]
                });

                var selModel = Ext.create('Ext.selection.CheckboxModel',{
                listeners:{
                selectionchange: function(sm,selections){
                Ext.getCmp("btnDel").setDisabled(selections.length == 0);
                }
                }
                });

                var gridPanel =  Ext.create('Ext.grid.Panel',{
                id:'gridPanel',
                border: false,
                loadMask: true,
                region: 'center',
                store: storeStaff,
                selModel:selModel,
                columns:[{
                xtype: 'rownumberer',
                width: 40,
                sortable: false
                },{
                text:'姓名',
                dataIndex:'name',
                width:100,
                },{
                text:'年龄',
                dataIndex:'age',
                width:70,
                },{
                text:'性别',
                dataIndex:'sex',
                width:70,
                renderer: function(key, p, record) {
                if(key==1){
                return "男";
                }else{
                return "女";
                }
                },
                },{
                text:'毕业学校',
                dataIndex:'edu',
                width:250,
                },{
                text:'工龄',
                dataIndex:'workage',
                width:70,
                },{
                text:'薪水',
                dataIndex:'salary',
                width:70,
                },{
                text:'居住地址',
                dataIndex:'address',
                flex:1,
                }],
                tbar:{
                xtype: 'container',
                items: [btnBar, filterBar]
                },
                bbar: Ext.create('Ext.PagingToolbar', {
                store: storeStaff,
                displayInfo: true,
                displayMsg: '显示记录 {0} - {1} 共 {2}',
                emptyMsg: "没有可显示的记录"
                })
                });
                storeStaff.loadPage(1);
                Ext.create('Ext.Viewport', {
                id: 'viewport',
                layout: 'border',
                items: [north,gridPanel],
                style: {
                background:'lightblue',
                },
                renderTo: document.body
                });        
                })

            </script>
        </head>
        <body>
        </body> 
    </html>    
